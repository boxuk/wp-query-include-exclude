{"version":3,"names":["useSelect","useDispatch","useRefEffect","store","blockEditorStore","getBlockClientId","extractSelectionStartNode","selection","anchorNode","anchorOffset","nodeType","TEXT_NODE","childNodes","extractSelectionEndNode","focusNode","focusOffset","length","findDepth","a","b","depth","setContentEditableWrapper","node","value","contentEditable","String","focus","useSelectionObserver","multiSelect","selectBlock","selectionChange","getBlockParents","getBlockSelectionStart","ownerDocument","defaultView","onSelectionChange","event","getSelection","rangeCount","isClickShift","shiftKey","type","isCollapsed","startClientId","endClientId","selectedClientId","clickedClientId","target","focusNodeIsNonSelectable","undefined","isSingularSelection","startPath","endPath","addListeners","addEventListener","removeListeners","removeEventListener","resetListeners"],"sources":["@wordpress/block-editor/src/components/writing-flow/use-selection-observer.js"],"sourcesContent":["/**\n * WordPress dependencies\n */\nimport { useSelect, useDispatch } from '@wordpress/data';\nimport { useRefEffect } from '@wordpress/compose';\n\n/**\n * Internal dependencies\n */\nimport { store as blockEditorStore } from '../../store';\nimport { getBlockClientId } from '../../utils/dom';\n\n/**\n * Extract the selection start node from the selection. When the anchor node is\n * not a text node, the selection offset is the index of a child node.\n *\n * @param {Selection} selection The selection.\n *\n * @return {Element} The selection start node.\n */\nfunction extractSelectionStartNode( selection ) {\n\tconst { anchorNode, anchorOffset } = selection;\n\n\tif ( anchorNode.nodeType === anchorNode.TEXT_NODE ) {\n\t\treturn anchorNode;\n\t}\n\n\tif ( anchorOffset === 0 ) {\n\t\treturn anchorNode;\n\t}\n\n\treturn anchorNode.childNodes[ anchorOffset - 1 ];\n}\n\n/**\n * Extract the selection end node from the selection. When the focus node is not\n * a text node, the selection offset is the index of a child node. The selection\n * reaches up to but excluding that child node.\n *\n * @param {Selection} selection The selection.\n *\n * @return {Element} The selection start node.\n */\nfunction extractSelectionEndNode( selection ) {\n\tconst { focusNode, focusOffset } = selection;\n\n\tif ( focusNode.nodeType === focusNode.TEXT_NODE ) {\n\t\treturn focusNode;\n\t}\n\n\tif ( focusOffset === focusNode.childNodes.length ) {\n\t\treturn focusNode;\n\t}\n\n\treturn focusNode.childNodes[ focusOffset ];\n}\n\nfunction findDepth( a, b ) {\n\tlet depth = 0;\n\n\twhile ( a[ depth ] === b[ depth ] ) {\n\t\tdepth++;\n\t}\n\n\treturn depth;\n}\n\n/**\n * Sets the `contenteditable` wrapper element to `value`.\n *\n * @param {HTMLElement} node  Block element.\n * @param {boolean}     value `contentEditable` value (true or false)\n */\nfunction setContentEditableWrapper( node, value ) {\n\t// Since we are calling this on every selection change, check if the value\n\t// needs to be updated first because it trigger the browser to recalculate\n\t// style.\n\tif ( node.contentEditable !== String( value ) )\n\t\tnode.contentEditable = value;\n\t// Firefox doesn't automatically move focus.\n\tif ( value ) node.focus();\n}\n\n/**\n * Sets a multi-selection based on the native selection across blocks.\n */\nexport default function useSelectionObserver() {\n\tconst { multiSelect, selectBlock, selectionChange } =\n\t\tuseDispatch( blockEditorStore );\n\tconst { getBlockParents, getBlockSelectionStart } =\n\t\tuseSelect( blockEditorStore );\n\treturn useRefEffect(\n\t\t( node ) => {\n\t\t\tconst { ownerDocument } = node;\n\t\t\tconst { defaultView } = ownerDocument;\n\n\t\t\tfunction onSelectionChange( event ) {\n\t\t\t\tconst selection = defaultView.getSelection();\n\n\t\t\t\tif ( ! selection.rangeCount ) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// If selection is collapsed and we haven't used `shift+click`,\n\t\t\t\t// end multi selection and disable the contentEditable wrapper.\n\t\t\t\t// We have to check about `shift+click` case because elements\n\t\t\t\t// that don't support text selection might be involved, and we might\n\t\t\t\t// update the clientIds to multi-select blocks.\n\t\t\t\t// For now we check if the event is a `mouse` event.\n\t\t\t\tconst isClickShift = event.shiftKey && event.type === 'mouseup';\n\t\t\t\tif ( selection.isCollapsed && ! isClickShift ) {\n\t\t\t\t\tsetContentEditableWrapper( node, false );\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tlet startClientId = getBlockClientId(\n\t\t\t\t\textractSelectionStartNode( selection )\n\t\t\t\t);\n\t\t\t\tlet endClientId = getBlockClientId(\n\t\t\t\t\textractSelectionEndNode( selection )\n\t\t\t\t);\n\t\t\t\t// If the selection has changed and we had pressed `shift+click`,\n\t\t\t\t// we need to check if in an element that doesn't support\n\t\t\t\t// text selection has been clicked.\n\t\t\t\tif ( isClickShift ) {\n\t\t\t\t\tconst selectedClientId = getBlockSelectionStart();\n\t\t\t\t\tconst clickedClientId = getBlockClientId( event.target );\n\t\t\t\t\t// `endClientId` is not defined if we end the selection by clicking a non-selectable block.\n\t\t\t\t\t// We need to check if there was already a selection with a non-selectable focusNode.\n\t\t\t\t\tconst focusNodeIsNonSelectable =\n\t\t\t\t\t\tclickedClientId !== endClientId;\n\t\t\t\t\tif (\n\t\t\t\t\t\t( startClientId === endClientId &&\n\t\t\t\t\t\t\tselection.isCollapsed ) ||\n\t\t\t\t\t\t! endClientId ||\n\t\t\t\t\t\tfocusNodeIsNonSelectable\n\t\t\t\t\t) {\n\t\t\t\t\t\tendClientId = clickedClientId;\n\t\t\t\t\t}\n\t\t\t\t\t// Handle the case when we have a non-selectable block\n\t\t\t\t\t// selected and click another one.\n\t\t\t\t\tif ( startClientId !== selectedClientId ) {\n\t\t\t\t\t\tstartClientId = selectedClientId;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// If the selection did not involve a block, return.\n\t\t\t\tif (\n\t\t\t\t\tstartClientId === undefined &&\n\t\t\t\t\tendClientId === undefined\n\t\t\t\t) {\n\t\t\t\t\tsetContentEditableWrapper( node, false );\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst isSingularSelection = startClientId === endClientId;\n\t\t\t\tif ( isSingularSelection ) {\n\t\t\t\t\tselectBlock( startClientId );\n\t\t\t\t} else {\n\t\t\t\t\tconst startPath = [\n\t\t\t\t\t\t...getBlockParents( startClientId ),\n\t\t\t\t\t\tstartClientId,\n\t\t\t\t\t];\n\t\t\t\t\tconst endPath = [\n\t\t\t\t\t\t...getBlockParents( endClientId ),\n\t\t\t\t\t\tendClientId,\n\t\t\t\t\t];\n\t\t\t\t\tconst depth = findDepth( startPath, endPath );\n\n\t\t\t\t\tmultiSelect( startPath[ depth ], endPath[ depth ] );\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfunction addListeners() {\n\t\t\t\townerDocument.addEventListener(\n\t\t\t\t\t'selectionchange',\n\t\t\t\t\tonSelectionChange\n\t\t\t\t);\n\t\t\t\tdefaultView.addEventListener( 'mouseup', onSelectionChange );\n\t\t\t}\n\n\t\t\tfunction removeListeners() {\n\t\t\t\townerDocument.removeEventListener(\n\t\t\t\t\t'selectionchange',\n\t\t\t\t\tonSelectionChange\n\t\t\t\t);\n\t\t\t\tdefaultView.removeEventListener( 'mouseup', onSelectionChange );\n\t\t\t}\n\n\t\t\tfunction resetListeners() {\n\t\t\t\tremoveListeners();\n\t\t\t\taddListeners();\n\t\t\t}\n\n\t\t\taddListeners();\n\t\t\t// We must allow rich text to set selection first. This ensures that\n\t\t\t// our `selectionchange` listener is always reset to be called after\n\t\t\t// the rich text one.\n\t\t\tnode.addEventListener( 'focusin', resetListeners );\n\t\t\treturn () => {\n\t\t\t\tremoveListeners();\n\t\t\t\tnode.removeEventListener( 'focusin', resetListeners );\n\t\t\t};\n\t\t},\n\t\t[ multiSelect, selectBlock, selectionChange, getBlockParents ]\n\t);\n}\n"],"mappings":"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"}